<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./Strength.png">
    <link rel="icon" type="image/jpeg" href="./Strength.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«ç´€éŒ„åŠ©æ‰‹ Pro</title>
    <meta name="apple-mobile-web-app-title" content="å¥èº«åŠ©æ‰‹">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<style>
        :root { --primary: #007AFF; --chest: #FF3B30; --shoulder: #FF9500; --arm: #4CD964; --leg: #5AC8FA; --bg: #F2F2F7; --danger: #FF3B30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 50px; }
        
        .timer-panel { 
            position: sticky; 
            top: 10px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px); 
            padding: 15px; 
            border-radius: 20px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.1); 
            z-index: 1000; 
            margin-bottom: 20px; 
            border: 1px solid #ddd; 
        }
        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }
        #timer-display { 
            font-size: 3.5rem; 
            font-weight: 800; 
            margin: 5px 0; 
            color: #1c1c1e; 
            line-height: 1.2;
            text-align: left; 
        }
        #set-counter {
            font-size: 1.2rem;
            font-weight: bold;
            color: #34c759;
            text-align: right;
        }
        .btn-group { display: flex; gap: 8px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px 5px; border-radius: 12px 12px 0 0; border: none; font-size: 0.9rem; font-weight: bold; color: white; opacity: 0.4; transition: 0.3s; }
        .tab-btn.active { opacity: 1; transform: translateY(-2px); }
    
        .card { background: white; border-radius: 0 0 18px 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .card.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .exercise-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        
        .input-group { display: flex; align-items: center; gap: 5px; }
        .weight-input { 
            width: 70px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            padding: 6px; 
            text-align: center; 
            font-size: 1.1rem; 
            font-weight: bold; 
            color: #007AFF; 
            background: white;
        }
        .unit-text { font-size: 0.9rem; color: #666; font-weight: bold; width: 20px; }
    
        .date-input { border: 1px solid #ddd; border-radius: 6px; padding: 6px; font-size: 1rem; font-weight: bold; background: #fff; }

        .btn-record { background: #34c759; color: white; padding: 14px; font-size: 16px; border-radius: 12px; width: 100%; margin-top: 15px; border:none; font-weight:bold; }
    
        .calendar-card { background: white; border-radius: 18px; padding: 15px; margin-top: 30px; }
        
        #delete-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.2s cubic-bezier(0.17, 0.89, 0.32, 1.28); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #modal-details { text-align: left; background: #F2F2F7; padding: 12px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; margin: 15px 0; white-space: pre-wrap; color: #333; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .btn-del { background: var(--danger); color: white; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; }
        .btn-ok { background: #E5E5EA; color: #000; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; }
        /* è®“æ—¥æ›†äº‹ä»¶æ–‡å­—ç½®ä¸­ */
        .fc-event-title {
            text-align: center;
            width: 100%;
            display: block;
            font-weight: bold;
        }
    
    /* é¡å¤–å„ªåŒ–ï¼šè®“äº‹ä»¶å®¹å™¨æ’æ»¿ä¸¦å‚ç›´ç½®ä¸­ */
    .fc-daygrid-event {
        justify-content: center !important;
    }
    
        .fc .fc-daygrid-day-frame { min-height: 40px !important; }
        .fc .fc-daygrid-body { min-height: 0 !important; }
        .fc .fc-scrollgrid-sync-table { height: auto !important; }
        .fc .fc-daygrid-day-top { justify-content: center !important; flex-direction: row !important; }
        .fc .fc-daygrid-day-number { padding: 2px 0 !important; font-size: 1.1rem; }
        .fc-daygrid-event { margin-top: 1px !important; padding: 0 2px !important; font-size: 0.75rem !important; }
        .fc .fc-col-header-cell { padding: 4px 0 !important; }
    </style>
</head>
<body>

 <audio id="alarm-sound" src="./music.mp3" preload="auto"></audio>

<div class="timer-panel">
    <div class="timer-header">
        <div id="timer-display">00:00</div>
        <div id="set-counter"></div>
    </div>
    <div class="btn-group">
         <button style="background:var(--primary);color:white;font-size:0.8rem;" onclick="handleRestClick(120)">çµ„æ•¸é–“éš”2min</button>
        <button style="background:#5856D6;color:white;font-size:0.8rem;" onclick="handleSwitchClick(240)">å‹•ä½œé–“éš”4min</button>
        <button style="background:#E5E5EA; flex: 0.4;font-size:1.2rem;" onclick="resetTimer()">â†º</button>
    </div>
</div>

<div class="tab-menu">
    <button class="tab-btn active" style="background:var(--chest)" onclick="switchTab(0)">ğŸ”¥ ç·´èƒ¸</button>
    <button class="tab-btn" style="background:var(--shoulder)" onclick="switchTab(1)">âš¡ ç·´è‚©</button>
    <button class="tab-btn" style="background:var(--arm)" onclick="switchTab(2)">ğŸ’ª ç·´è‡‚</button>
    <button class="tab-btn" style="background:var(--leg)" onclick="switchTab(3)">ğŸƒ æœ‰æ°§</button>
</div>

<div class="card active" id="card-chest" data-type="chest">
    <div class="card-header"><h3 style="color:var(--chest);margin:0;">ç·´èƒ¸å…§å®¹</h3><input type="date" class="date-input" onchange="syncDate(this)"></div>
    <div class="exercise-item"><span>å•éˆ´è‡¥æ¨</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="chest_1" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´ä¸‹æ–œè‡¥æ¨</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="chest_2" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´çª„æ¨</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="chest_3" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´é£›é³¥</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="chest_4" placeholder="0"><span class="unit-text">kg</span></div></div>
    <button class="btn-record" onclick="saveToHistory('ç·´èƒ¸', this, '#FF3B30')">ğŸ’¾ å„²å­˜åˆ°æ—¥æ›†</button>
</div>

<div class="card" id="card-shoulder" data-type="shoulder">
    <div class="card-header"><h3 style="color:var(--shoulder);margin:0;">ç·´è‚©å…§å®¹</h3><input type="date" class="date-input" onchange="syncDate(this)"></div>
    <div class="exercise-item"><span>å•éˆ´è‚©æ¨</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="sh_1" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´æ­£æ‰‹åˆ’èˆ¹</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="sh_2" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´å´å¹³èˆ‰</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="sh_3" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´å‰å¹³èˆ‰</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="sh_4" placeholder="0"><span class="unit-text">kg</span></div></div>
    <button class="btn-record" onclick="saveToHistory('ç·´è‚©', this, '#FF9500')">ğŸ’¾ å„²å­˜åˆ°æ—¥æ›†</button>
</div>

<div class="card" id="card-arm" data-type="arm">
    <div class="card-header"><h3 style="color:var(--arm);margin:0;">ç·´è‡‚å…§å®¹</h3><input type="date" class="date-input" onchange="syncDate(this)"></div>
    <div class="exercise-item"><span>å•éˆ´å½èˆ‰</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="arm_1" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´å‚å¼å½èˆ‰</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="arm_2" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´ä¿¯å¾Œè‡‚å±ˆä¼¸</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="arm_3" placeholder="0"><span class="unit-text">kg</span></div></div>
    <div class="exercise-item"><span>å•éˆ´é ¸å¾Œè‡‚å±ˆä¼¸</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="arm_4" placeholder="0"><span class="unit-text">kg</span></div></div>
    <button class="btn-record" onclick="saveToHistory('ç·´è‡‚', this, '#4CD964')">ğŸ’¾ å„²å­˜åˆ°æ—¥æ›†</button>
</div>

<div class="card" id="card-leg" data-type="leg">
    <div class="card-header"><h3 style="color:var(--leg);margin:0;">è·‘æ­¥</h3><input type="date" class="date-input" onchange="syncDate(this)"></div>
    
    <div class="exercise-item">
        <span>ç›®å‰é«”é‡</span>
        <div class="input-group">
            <input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="body_weight" placeholder="0">
            <span class="unit-text">kg</span>
        </div>
    </div>

    <div class="exercise-item"><span>è·é›¢</span><div class="input-group"><input type="number" step="any" inputmode="decimal" class="weight-input" oninput="saveCurrentWeight(this)" data-id="leg_1" placeholder="0"><span class="unit-text">km</span></div></div>
    
    <div class="exercise-item">
        <span>æ™‚é–“</span>
        <div class="input-group">
            <input type="number" inputmode="decimal" class="weight-input" style="width: 40px;" 
                   id="input-hr" oninput="saveCurrentWeight(this)" data-id="leg_hr" placeholder="0">
            <span class="unit-text" style="width: 15px;">æ™‚</span>
            <input type="number" inputmode="decimal" class="weight-input" style="width: 40px;" 
                   id="input-min" oninput="saveCurrentWeight(this)" data-id="leg_min" placeholder="0">
            <span class="unit-text" style="width: 15px;">åˆ†</span>
            <input type="number" inputmode="decimal" class="weight-input" style="width: 40px;" 
                   id="input-sec" oninput="saveCurrentWeight(this)" data-id="leg_sec" placeholder="0">
            <span class="unit-text" style="width: 15px;">ç§’</span>
        </div>
    </div>

    <div class="exercise-item" style="background: #f0f9ff; border-radius: 12px; margin-top: 10px; padding: 12px; border-bottom: none;">
        <div style="flex: 1; text-align: center;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">å¹³å‡é…é€Ÿ</div>
            <div id="display-pace" style="font-weight: 800; color: var(--primary); font-size: 1.2rem;">--'--"</div>
        </div>
        <div style="width: 1px; height: 30px; background: #ddd; margin: 0 10px;"></div>
        <div style="flex: 1; text-align: center;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">é ä¼°ç‡ƒç‡’</div>
            <div id="display-calories" style="font-weight: 800; color: #FF9500; font-size: 1.2rem;">0 kcal</div>
        </div>
    </div>
    
    <button class="btn-record" onclick="saveToHistory('æœ‰æ°§', this, '#5AC8FA')">ğŸ’¾ å„²å­˜åˆ°æ—¥æ›†</button>
</div>


<div class="calendar-card"><div id="calendar"></div></div>

<div id="delete-modal">
    <div class="modal-content">
        <h3 id="modal-title" style="margin:0; color:#1c1c1e;">æç¤º</h3>
        <div id="modal-details"></div>
        <div class="modal-btns">
            <button class="btn-del" id="confirm-delete">åˆªé™¤æœ¬ç­†ç´€éŒ„</button>
            <button class="btn-ok" id="modal-close-btn" onclick="closeModal()">ç¢ºå®š</button>
        </div>
    </div>
</div>
<div style="display:flex; gap:10px; margin:20px 0;">
    <button class="btn-record" style="background:#007AFF;" onclick="exportHistory()">
        ğŸ“¤ åŒ¯å‡ºè¨“ç·´ç´€éŒ„
    </button>

    <button class="btn-record" style="background:#5856D6;" onclick="triggerImport()">
        ğŸ“¥ åŒ¯å…¥è¨“ç·´ç´€éŒ„
    </button>

    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importHistory(event)">
</div>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    let calendar;
    let countdown;
    let currentEventInfo = null;
    let setNum = 0; 
    let tempValue = "";

    window.onload = function() {
        var today = new Date().toLocaleDateString('sv-SE'); 
        document.querySelectorAll('.date-input').forEach(function(input) {
            input.value = today;
        });

        initCalendar();
        loadAllWeights();
        initAutoJump();
        
        var cardioIds = ['body_weight', 'leg_1', 'leg_hr', 'leg_min', 'leg_sec'];
        cardioIds.forEach(function(id) {
            var el = document.querySelector('[data-id="' + id + '"]');
            if(el) {
                el.addEventListener('input', updateCardioStats);
                el.addEventListener('change', updateCardioStats);
            }
        });

        updateCardioStats();
    };


    function exportHistory() {
    var history = localStorage.getItem('gym_history');
    if (!history || history === "[]") {
        showNotice("æ²’æœ‰è³‡æ–™", "ç›®å‰æ²’æœ‰ä»»ä½•è¨“ç·´ç´€éŒ„å¯ä»¥åŒ¯å‡º", false);
        return;
    }

    var blob = new Blob([history], { type: "application/json;charset=utf-8;" });
    var url = URL.createObjectURL(blob);

    var a = document.createElement("a");
    a.href = url;
    a.download = "gym_history_backup_" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotice("åŒ¯å‡ºå®Œæˆ", "è¨“ç·´ç´€éŒ„å·²ä¸‹è¼‰æˆ JSON æª”", false);
}

    function importHistory(event) {
    var file = event.target.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var importedData = JSON.parse(e.target.result);

            if (!Array.isArray(importedData)) {
                throw new Error("æ ¼å¼éŒ¯èª¤");
            }

            // è¦†è“‹ localStorage
            localStorage.setItem('gym_history', JSON.stringify(importedData));

            // é‡æ–°è¼‰å…¥æ—¥æ›†
            calendar.removeAllEvents();
            importedData.forEach(function(ev) {
                calendar.addEvent(ev);
            });

            showNotice("åŒ¯å…¥æˆåŠŸ", "è¨“ç·´ç´€éŒ„å·²æˆåŠŸé‚„åŸ ğŸ‰", false);
        } catch (err) {
            showNotice("åŒ¯å…¥å¤±æ•—", "æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ä¸æ˜¯æœ‰æ•ˆçš„ç´€éŒ„æª”", false);
        }
    };

    reader.readAsText(file);
}

    function triggerImport() {
    document.getElementById('import-file').value = "";
    document.getElementById('import-file').click();
}

    function updateCardioStats() {
    var weightInput = document.querySelector('[data-id="body_weight"]');
    var distInput = document.querySelector('[data-id="leg_1"]');
    var hrInput = document.getElementById('input-hr');
    var minInput = document.getElementById('input-min');
    var secInput = document.getElementById('input-sec');

    if(!weightInput || !distInput) return;

    var weight = parseFloat(weightInput.value) || 0;
    var dist = parseFloat(distInput.value) || 0;
    var hr = parseInt(hrInput.value) || 0;
    var min = parseInt(minInput.value) || 0;
    var sec = parseInt(secInput.value) || 0;

    var totalSeconds = (hr * 3600) + (min * 60) + sec;
    var totalHours = totalSeconds / 3600;

    var paceDisplay = document.getElementById('display-pace');
    var speedKph = 0;
    
    if (dist > 0 && totalSeconds > 0) {
        var paceTotalSecPerKm = totalSeconds / dist;
        var pMin = Math.floor(paceTotalSecPerKm / 60);
        var pSec = Math.round(paceTotalSecPerKm % 60);
        var displaySec = (pSec < 10) ? ("0" + pSec) : pSec;
        paceDisplay.innerText = pMin + "'" + displaySec + '"';
        speedKph = dist / totalHours;
    } else {
        paceDisplay.innerText = "--'--\"";
    }

    var kcalDisplay = document.getElementById('display-calories');
    if (weight > 0 && dist > 0 && totalHours > 0) {
        var met = 1.0; 
        if (speedKph <= 0) met = 1.0;
        else if (speedKph < 5) met = 3.5;
        else if (speedKph < 7) met = 6.0;
        else if (speedKph < 9) met = 8.3;
        else if (speedKph < 11) met = 9.8;
        else if (speedKph < 13) met = 11.5;
        else met = 12.8;
        var kcal = met * weight * totalHours;
        kcalDisplay.innerText = Math.round(kcal) + " kcal";
    } else {
        if (weight > 0 && dist > 0) {
            var fallbackKcal = weight * dist * 1.036;
            kcalDisplay.innerText = Math.round(fallbackKcal) + " kcal";
        } else {
            kcalDisplay.innerText = "0 kcal";
        }
    }
}

    function initAutoJump() {
        var hrInput = document.getElementById('input-hr');
        var minInput = document.getElementById('input-min');
        var secInput = document.getElementById('input-sec');
        if(hrInput && minInput && secInput) {
            hrInput.addEventListener('input', function() { if (this.value.length >= 2) minInput.focus(); });
            minInput.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    var val = parseInt(this.value);
                    if (val > 99) this.value = "99";
                    secInput.focus();
                }
            });
            secInput.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    var val = parseInt(this.value);
                    if (val > 59) this.value = "59";
                    this.blur(); 
                }
            });
        }
    }

    function showNotice(title, content, showDelete) {
        var titleEl = document.getElementById('modal-title');
        var detailsEl = document.getElementById('modal-details');
        titleEl.innerText = title;
        if (content && content.trim() !== "") {
            detailsEl.innerText = content;
            detailsEl.style.display = 'block';
        } else {
            detailsEl.style.display = 'none';
        }
        document.getElementById('confirm-delete').style.display = showDelete ? 'block' : 'none';
        document.getElementById('modal-close-btn').innerText = showDelete ? 'é—œé–‰' : 'ç¢ºå®š';
        document.getElementById('delete-modal').style.display = 'flex';
    }
    
    function closeModal() {
        // åœæ­¢é¬§é˜éŸ³æ¨‚ä¸¦æ­¸é›¶
        var alarm = document.getElementById('alarm-sound');
        if (alarm) {
            alarm.pause();
            alarm.currentTime = 0;
        }
        
        // é—œé–‰è¦–çª—
        document.getElementById('delete-modal').style.display = 'none';
        currentEventInfo = null;
    }
    

    function syncDate(sourceInput) {
        var newDate = sourceInput.value;
        document.querySelectorAll('.date-input').forEach(function(input) { input.value = newDate; });
    }

    function saveCurrentWeight(input) {
        var id = input.dataset.id;
        var val = input.value === "" ? "0" : input.value; 
        var currentWeights = JSON.parse(localStorage.getItem('current_weights') || "{}");
        currentWeights[id] = val;
        localStorage.setItem('current_weights', JSON.stringify(currentWeights));
        updateCardioStats();
    }

    function loadAllWeights() {
        var currentWeights = JSON.parse(localStorage.getItem('current_weights') || "{}");
        document.querySelectorAll('.weight-input').forEach(function(input) {
            var id = input.dataset.id;
            if(!id) return;
            if (id.startsWith('leg_') && id !== 'body_weight') {
                input.value = "0";
                currentWeights[id] = "0";
            } else {
                input.value = (currentWeights[id] !== undefined && currentWeights[id] !== "") ? currentWeights[id] : "0";
            }
            input.addEventListener('focus', function() { tempValue = this.value; this.value = ""; });
            input.addEventListener('blur', function() {
                if (this.value === "" || isNaN(this.value)) { this.value = tempValue; } 
                else { this.value = parseFloat(this.value).toString(); }
                saveCurrentWeight(this);
            });
        });
        localStorage.setItem('current_weights', JSON.stringify(currentWeights));
        updateCardioStats();
    }

    function switchTab(index) {
        document.querySelectorAll('.tab-btn').forEach(function(btn, i) { btn.classList.toggle('active', i === index); });
        document.querySelectorAll('.card').forEach(function(card, i) { card.classList.toggle('active', i === index); });
    }

    function handleRestClick(seconds) {
        setNum++; 
        document.getElementById('set-counter').innerText = "ç¬¬ " + setNum + " çµ„å®Œæˆ ";
        startTimer(seconds);
    }

    function handleSwitchClick(seconds) {
        setNum = 0;
        document.getElementById('set-counter').innerText = "";
        startTimer(seconds);
    }

    function resetTimer() { 
        clearInterval(countdown); 
        var alarm = document.getElementById('alarm-sound');
        alarm.pause();
        alarm.currentTime = 0;
        document.querySelector('#timer-display').innerText = "00:00"; 
        setNum = 0;
        document.getElementById('set-counter').innerText = "";
    }

    function startTimer(s) {
            clearInterval(countdown);
            var display = document.querySelector('#timer-display');
            var alarm = document.getElementById('alarm-sound');
            alarm.load(); 
            var then = Date.now() + s * 1000;
            function updateDisplay() {
                var left = Math.round((then - Date.now()) / 1000);
                if (left <= 0) { 
                    clearInterval(countdown); 
                    display.innerText = "00:00";
                    
                    // å€’æ•¸çµæŸæ‰æ’­æ”¾
                    alarm.play();
                    showNotice("è¨ˆæ™‚çµæŸ", "æ™‚é–“åˆ°ï¼è©²é–‹å§‹ä¸‹ä¸€çµ„äº† ğŸ‹ï¸", false);
                    return; 
                }
                var m = Math.floor(left / 60);
                var rs = left % 60;
                display.innerText = (m < 10 ? '0' + m : m) + ":" + (rs < 10 ? '0' + rs : rs);
            }
            updateDisplay();
            countdown = setInterval(updateDisplay, 1000);
        }

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', 
            locale: 'zh-tw', 
            height: 'auto', 
            headerToolbar: { left: 'prev', center: 'title', right: 'next' },
            dayCellContent: function(arg) { return arg.date.getDate(); },
            // é‡è¦ï¼šè¨­å®šæ’åºè¦å‰‡ç‚º order å±¬æ€§å‡åº
            eventOrder: "order",
            events: JSON.parse(localStorage.getItem('gym_history') || "[]"),
            eventClick: function(info) { 
                currentEventInfo = info; 
                var details = info.event.extendedProps.note || "ç„¡è©³ç´°å…§å®¹";
                var title = info.event.title + " (" + info.event.startStr + ")";
                showNotice(title, details, true); 
            }
        });
        calendar.render();
    }

    document.getElementById('confirm-delete').onclick = function() {
        if (currentEventInfo) {
            currentEventInfo.event.remove();
            var history = JSON.parse(localStorage.getItem('gym_history') || "[]");
            history = history.filter(function(item) { return item.id !== currentEventInfo.event.id; });
            localStorage.setItem('gym_history', JSON.stringify(history));
            closeModal();
        }
    };

    function saveToHistory(type, btnElement, color) {
        var card = btnElement.closest('.card');
        var dateVal = card.querySelector('.date-input').value; 
        if (!dateVal) { showNotice("è­¦å‘Š", "è«‹é¸æ“‡æ—¥æœŸ", false); return; }
        
        // å®šç¾©é¡¯ç¤ºé †åºæ¬Šé‡ï¼šèƒ¸=1, è‚©=2, è‡‚=3, æœ‰æ°§=4
        var orderWeight = 99;
        if(type === 'ç·´èƒ¸') orderWeight = 1;
        else if(type === 'ç·´è‚©') orderWeight = 2;
        else if(type === 'ç·´è‡‚') orderWeight = 3;
        else if(type === 'æœ‰æ°§') orderWeight = 4;

        var details = "";
        if (type === 'æœ‰æ°§') {
            var weight = card.querySelector('[data-id="body_weight"]').value || "0";
            var dist = card.querySelector('[data-id="leg_1"]').value || "0";
            var hr = parseInt(card.querySelector('[data-id="leg_hr"]').value) || 0;
            var min = parseInt(card.querySelector('[data-id="leg_min"]').value) || 0;
            var sec = parseInt(card.querySelector('[data-id="leg_sec"]').value) || 0;
            var pace = document.getElementById('display-pace').innerText;
            var kcal = document.getElementById('display-calories').innerText;
            details += "â— è·é›¢: " + dist + " km\n";
            var timeStr = (hr > 0 ? hr + " æ™‚ " + (min < 10 ? '0' + min : min) : min) + " åˆ† " + (sec < 10 ? '0' + sec : sec) + " ç§’";
            details += "â— æ™‚é–“: " + timeStr + "\n";
            details += "â— é…é€Ÿ: " + pace + "\n";
            details += "â— æ¶ˆè€—: " + kcal + "\n";
        } else {
            card.querySelectorAll('.exercise-item').forEach(function(item) {
                var nameSpan = item.querySelector('span');
                var weightInput = item.querySelector('.weight-input');
                if (nameSpan && weightInput) {
                    var name = nameSpan.innerText;
                    var unit = item.querySelector('.unit-text').innerText; 
                    var weight = weightInput.value === "" ? "0" : weightInput.value;
                    details += "â— " + name + ": " + weight + " " + unit + "\n";
                }
            });
        }
        var history = JSON.parse(localStorage.getItem('gym_history') || "[]");
        var existingIndex = history.findIndex(function(item) { return item.start === dateVal && item.title === type; });
        if (existingIndex > -1) {
            history[existingIndex].extendedProps.note = details;
            // æ›´æ–°æ™‚ä¹Ÿè¦ç¢ºä¿ order è¢«å¯«å…¥
            history[existingIndex].order = orderWeight;
            var oldEvent = calendar.getEvents().find(function(e) { return e.startStr === dateVal && e.title === type; });
            if (oldEvent) oldEvent.setExtendedProp('note', details);
            showNotice("è¨“ç·´ç´€éŒ„å·²æ›´æ–°", "", false);
        } else {
            var uniqueId = "id_" + Date.now();
            var newRecord = { 
                id: uniqueId, 
                title: type, 
                start: dateVal, 
                backgroundColor: color, 
                borderColor: color, 
                order: orderWeight, // åŠ å…¥æ’åºæ¬„ä½
                extendedProps: { note: details } 
            };
            history.push(newRecord);
            calendar.addEvent(newRecord);
            showNotice("è¨“ç·´ç´€éŒ„å·²å„²å­˜", "", false);
        }
        localStorage.setItem('gym_history', JSON.stringify(history));
    }

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

</script>
</body>
</html>
